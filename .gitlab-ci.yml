workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

variables:
  GIT_STRATEGY: fetch
  DOCKER_CONTAINER: ${CI_PROJECT_NAME}
  DOCKER_IMAGE: ${CI_PROJECT_NAME}:${CI_COMMIT_SHA}
  
  INTERNAL_NETWORK_NAME: midtob-internal
  INTERNAL_STATIC_IP: 172.18.0.38
  PORT: 9006

  DATABASE_URL: jdbc:mysql://172.18.0.16:3306/housing_db
  DATABASE_USERNAME: root
  DATABASE_PASSWORD: midtob

  # EUREKA_SERVER: http://172.18.0.3:8761/eureka
  # KAFKA_BROKER_HOST_VIA_NGINX: midtob.com=172.18.0.2
  # KAFKA_SERVER: 172.18.0.2:9092
  USER_SERVICE: 172.18.0.33:9002

  CPU_COUNT: 8
  CPU_SHARES: 4096

stages:
  - build
  - deploy

build:
  stage: build
  script:
    - docker build -t $DOCKER_IMAGE .
  tags:
    - housing-service
    - ci/cd
    - deploy
  only:
    - main

deploy:
  stage: deploy
  script:
    - docker rm -f $DOCKER_CONTAINER
    - docker run -d 
      --name $DOCKER_CONTAINER 
      --network $INTERNAL_NETWORK_NAME 
      --ip $INTERNAL_STATIC_IP 
      --env PORT=$PORT 
      --env DATABASE_URL=$DATABASE_URL
      --env DATABASE_USERNAME=$DATABASE_USERNAME
      --env DATABASE_PASSWORD=$DATABASE_PASSWORD
      --env USER_SERVICE=$USER_SERVICE
      --cpus="$CPU_COUNT" 
      --cpu-shares=$CPU_SHARES $DOCKER_IMAGE
  tags:
    - housing-service
    - ci/cd
    - deploy
  only:
    - main